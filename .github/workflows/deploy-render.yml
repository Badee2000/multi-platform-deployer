name: Deploy to Render

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Check deployment readiness
      run: |
        python -c "
from src.main import Deployer
deployer = Deployer('.')
is_ready, results = deployer.check_deployment_readiness('flask')
if not is_ready:
    print('Application not ready for deployment')
    exit(1)
print('✓ Application is ready for deployment')
"
    
    - name: Deploy to Render
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        echo "Deploying to Render..."
        # Add render deployment script
        python -c "
from src.main import Deployer
deployer = Deployer('.')
success = deployer.deploy('render', run_migrations=True)
exit(0 if success else 1)
"
    
    - name: Verify deployment
      run: |
        echo "Verifying deployment..."
        # Add health check script
        sleep 30  # Wait for deployment to be ready
        python -c "
from src.main import Deployer
deployer = Deployer('.')
results = deployer.check_health('https://your-app.onrender.com')
print('✓ Deployment verified')
" || echo "Health check in progress..."
